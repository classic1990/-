import { useEffect, useState, useCallback } from "react";
import { initializeApp, getApps, getApp } from "firebase/app";
import {
  getAuth,
  onAuthStateChanged,
  GoogleAuthProvider,
  signInWithPopup,
  User
} from "firebase/auth";
import {
  getFirestore,
  collection,
  doc,
  addDoc,
  updateDoc,
  deleteDoc,
  onSnapshot,
} from "firebase/firestore";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Checkbox } from "@/components/ui/checkbox";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { LogOut, Edit2, Trash2, LogIn, Database, Youtube, Loader2, Sparkles, Wand2, Image as ImageIcon } from "lucide-react";
import { toast } from "sonner";
import { firebaseConfig } from "../firebaseConfig";

// --- Configuration ---
const ADMIN_EMAIL = "duy.kan1234@gmail.com";
const YOUTUBE_API_KEY = import.meta.env.VITE_YOUTUBE_API_KEY;
const GEMINI_API_KEY = import.meta.env.VITE_GEMINI_API_KEY;


// --- Firebase Setup ---
const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

// --- Types ---
export interface Movie {
  title: string;
  desc: string;
  category: "vertical" | "series";
  poster: string;
  badge?: string;
  isVip: boolean;
  episodes: { url: string; title?: string }[];
}

// --- Gemini API Utility ---
const callGemini = async (prompt: string, systemPrompt: string = "") => {
  if (!GEMINI_API_KEY) {
    toast.error("Gemini API Key is not configured.");
    return;
  }
  const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      contents: [{ parts: [{ text: prompt }] }],
      systemInstruction: { parts: [{ text: systemPrompt }] }
    })
  });
  if (!response.ok) {
     toast.error("Gemini API error.");
     return;
  }
  const result = await response.json();
  return result.candidates?.[0]?.content?.parts?.[0]?.text;
};

const generateAIImage = async (prompt: string) => {
    // This is a placeholder for a real image generation API
    // For this example, we'll use a placeholder service
    return `https://dummyimage.com/600x400/000/fff&text=${encodeURIComponent(prompt)}`;
};


export default function AdminPanel() {
  const [user, setUser] = useState<User | null>(null);
  const [isAdmin, setIsAdmin] = useState(false);
  const [loading, setLoading] = useState(true);
  const [movies, setMovies] = useState<(Movie & { id: string })[]>([]);
  const [editingId, setEditingId] = useState<string | null>(null);

  const [youtubeUrl, setYoutubeUrl] = useState("");
  const [isFetchingYoutube, setIsFetchingYoutube] = useState(false);
  const [isAILoading, setIsAILoading] = useState(false);
  const [isImageLoading, setIsImageLoading] = useState(false);

  const [formData, setFormData] = useState<Movie>({
    title: "",
    desc: "",
    category: "vertical",
    poster: "",
    badge: "",
    isVip: false,
    episodes: []
  });

  // 1. Authentication
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      setIsAdmin(currentUser?.email === ADMIN_EMAIL);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // 2. Data Fetching
  useEffect(() => {
    if (!isAdmin) {
      setMovies([]);
      return;
    }
    const unsubscribe = onSnapshot(collection(db, 'movies'),
      (snapshot) => {
        const moviesList = snapshot.docs.map(doc => ({ ...(doc.data() as Movie), id: doc.id }));
        setMovies(moviesList);
      },
      (error) => {
        console.error("Firestore read error:", error);
        toast.error("ไม่สามารถโหลดข้อมูลได้");
      }
    );
    return () => unsubscribe();
  }, [isAdmin]);

  const handleSignIn = async () => {
    try {
      await signInWithPopup(auth, provider);
    } catch (error) {
      toast.error("เข้าสู่ระบบล้มเหลว");
    }
  };

  const resetForm = () => {
    setFormData({ title: "", desc: "", category: "vertical", poster: "", badge: "", isVip: false, episodes: [] });
    setEditingId(null);
    setYoutubeUrl("");
  };

  const handleAddEpisode = () => {
    setFormData({ ...formData, episodes: [...formData.episodes, { url: "", title: "" }] });
  };

  const handleRemoveEpisode = (index: number) => {
    setFormData({ ...formData, episodes: formData.episodes.filter((_, i) => i !== index) });
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!isAdmin) return;
    if (!formData.title || !formData.poster) {
      toast.error("กรุณากรอกชื่อเรื่องและ URL โปสเตอร์");
      return;
    }

    try {
      if (editingId) {
        await updateDoc(doc(db, 'movies', editingId), { ...formData });
        toast.success("อัปเดตข้อมูลสำเร็จ");
      } else {
        await addDoc(collection(db, 'movies'), formData);
        toast.success("เพิ่มหนังใหม่สำเร็จ");
      }
      resetForm();
    } catch (error) {
      console.error("Save error:", error);
      toast.error("บันทึกข้อมูลล้มเหลว");
    }
  };

  const handleEdit = (movie: Movie & { id: string }) => {
    setFormData(movie);
    setEditingId(movie.id);
    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  const handleDelete = async (id: string) => {
    if (!isAdmin || !confirm("ต้องการลบข้อมูลนี้ใช่หรือไม่?")) return;
    try {
      await deleteDoc(doc(db, 'movies', id));
      toast.success("ลบข้อมูลสำเร็จ");
    } catch (error) {
      toast.error("ลบข้อมูลล้มเหลว");
    }
  };
  
    const handleAIRewriteDesc = async () => {
    if (!formData.desc) return;
    setIsAILoading(true);
    try {
      const prompt = `Rewrite this movie description to be more engaging and appealing, in Thai: ${formData.desc}`;
      const rewritten = await callGemini(prompt, "You are a professional movie critic and copywriter.");
      if (rewritten) setFormData(prev => ({ ...prev, desc: rewritten.trim() }));
    } finally { setIsAILoading(false); }
  };

  const handleAIGenerateBadge = async () => {
    if (!formData.title) return;
    setIsAILoading(true);
    try {
      const prompt = `Suggest a short, catchy 1-2 word Thai genre or tag for the movie titled: "${formData.title}"`;
      const badge = await callGemini(prompt, "Return only the suggested word(s) in Thai.");
      if (badge) setFormData(prev => ({ ...prev, badge: badge.trim().replace(/[\."]/g, '') }));
    } finally { setIsAILoading(false); }
  };

  const handleAIGeneratePoster = async () => {
    if (!formData.title) return;
    setIsImageLoading(true);
    try {
      const imageUrl = await generateAIImage(formData.title);
      if (imageUrl) setFormData(prev => ({ ...prev, poster: imageUrl }));
    } finally { setIsImageLoading(false); }
  };

  const handleAIImport = useCallback(async (targetUrl: string) => {
    if (!targetUrl || !YOUTUBE_API_KEY) {
      if(!YOUTUBE_API_KEY) toast.error("ไม่ได้ตั้งค่า YouTube API Key");
      return;
    }
    setIsFetchingYoutube(true);
    try {
        const videoId = targetUrl.match(/(?:v=|\/)([0-9A-Za-z_-]{11}).*/)?.[1];
        if (videoId) {
            const vRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${YOUTUBE_API_KEY}`);
            const vData = await vRes.json();
            const snippet = vData.items?.[0]?.snippet;
            if (snippet) {
                setFormData(prev => ({
                    ...prev,
                    title: snippet.title,
                    desc: snippet.description.substring(0, 800),
                    poster: snippet.thumbnails?.maxres?.url || snippet.thumbnails?.high?.url || "",
                    episodes: prev.episodes.length > 0 ? prev.episodes : [{ url: targetUrl, title: snippet.title }]
                }));
                toast.success("ดึงข้อมูลจาก YouTube สำเร็จ");
            }
        }
    } finally { setIsFetchingYoutube(false); }
  }, []);

  useEffect(() => {
    const delayDebounce = setTimeout(() => {
      if (youtubeUrl && !isFetchingYoutube) handleAIImport(youtubeUrl);
    }, 1000);
    return () => clearTimeout(delayDebounce);
  }, [youtubeUrl, isFetchingYoutube, handleAIImport]);

  if (loading) return <div className="flex h-screen items-center justify-center">กำลังเชื่อมต่อ...</div>;

  if (!isAdmin) {
    return (
      <div className="flex h-screen items-center justify-center bg-background">
        <Card className="w-[380px]">
          <CardHeader>
            <CardTitle>แผงควบคุมสำหรับแอดมิน</CardTitle>
            <CardDescription>กรุณาเข้าสู่ระบบด้วยบัญชี Google ของผู้ดูแล</CardDescription>
          </CardHeader>
          <CardContent>
            <Button className="w-full" onClick={handleSignIn}>
              <LogIn className="mr-2 h-4 w-4" /> เข้าสู่ระบบด้วย Google
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background text-foreground pb-10">
      <div className="sticky top-0 z-40 border-b bg-background/90 backdrop-blur-xl">
        <div className="container mx-auto flex items-center justify-between px-4 py-4">
          <h1 className="text-xl font-bold flex items-center gap-2">
            <Database className="h-5 w-5 text-blue-500" /> แผงควบคุม
          </h1>
          <div className="flex items-center gap-4">
            <span className="text-xs text-muted-foreground">{user?.email}</span>
            <Button onClick={() => auth.signOut()} variant="ghost" size="sm"><LogOut className="h-4 w-4" /> ออกจากระบบ</Button>
          </div>
        </div>
      </div>

      <div className="container mx-auto px-4 py-8">
        <div className="grid grid-cols-1 gap-8 lg:grid-cols-3">
          {/* Form Section */}
          <div className="lg:col-span-1">
            <Card className="border-blue-500/20 shadow-xl shadow-blue-500/5 overflow-hidden">
                <div className="h-1 bg-gradient-to-r from-blue-500 to-purple-600" />
                <CardHeader>
                    <CardTitle className="text-lg">{editingId ? "แก้ไขข้อมูลหนัง" : "เพิ่มหนังใหม่"}</CardTitle>
                    <CardDescription>ข้อมูลจะถูกบันทึกลงฐานข้อมูลโดยอัตโนมัติ</CardDescription>
                </CardHeader>
                <CardContent>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="space-y-4">
                            <div className="p-3 bg-red-500/5 rounded-lg border border-red-500/10">
                                <label className="text-[10px] font-bold text-red-600 uppercase mb-1 block flex items-center gap-1">
                                  <Youtube className="h-4 w-4" />  ดึงข้อมูลจาก YouTube
                                </label>
                                <Input
                                    value={youtubeUrl}
                                    onChange={(e) => setYoutubeUrl(e.target.value)}
                                    placeholder="วางลิงก์ YouTube ที่นี่เพื่อดึงข้อมูล"
                                    className="h-8 text-xs"
                                />
                                {isFetchingYoutube && <p className="text-xs text-muted-foreground mt-1">กำลังดึงข้อมูล...</p>}
                            </div>

                            <Input value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} placeholder="ชื่อเรื่อง" required />

                            <div className="relative">
                                <Textarea
                                    value={formData.desc}
                                    onChange={e => setFormData({...formData, desc: e.target.value})}
                                    placeholder="เรื่องย่อ"
                                    className="min-h-[100px] text-xs"
                                />
                                <Button type="button" variant="ghost" size="sm" onClick={handleAIRewriteDesc} className="absolute bottom-2 right-2 h-6 text-[10px] bg-background/50">
                                    {isAILoading ? <Loader2 className="h-3 w-3 animate-spin" /> : <><Sparkles className="h-3 w-3 text-purple-500 mr-1" /> AI แก้ไข</>}
                                </Button>
                            </div>

                            <div className="grid grid-cols-2 gap-2">
                                <Select value={formData.category} onValueChange={(v:any) => setFormData({...formData, category: v})}>
                                    <SelectTrigger className="h-9"><SelectValue placeholder="หมวดหมู่" /></SelectTrigger>
                                    <SelectContent>
                                        <SelectItem value="vertical">หนังตอนเดียว</SelectItem>
                                        <SelectItem value="series">ซีรีส์</SelectItem>
                                    </SelectContent>
                                </Select>
                                <div className="relative">
                                    <Input value={formData.badge} onChange={e => setFormData({...formData, badge: e.target.value})} placeholder="ป้ายกำกับ (เช่น ใหม่)" className="h-9" />
                                    <button type="button" onClick={handleAIGenerateBadge} className="absolute right-2 top-2.5 text-purple-500"><Wand2 className="h-4 w-4" /></button>
                                </div>
                            </div>

                            <div className="flex gap-2">
                                <Input value={formData.poster} onChange={e => setFormData({...formData, poster: e.target.value})} placeholder="URL รูปโปสเตอร์" className="text-xs" required />
                                <Button type="button" size="icon" variant="outline" onClick={handleAIGeneratePoster} disabled={isImageLoading || !formData.title}>
                                    {isImageLoading ? <Loader2 className="h-4 w-4 animate-spin" /> : <ImageIcon className="h-4 w-4" />}
                                </Button>
                            </div>

                            <div className="flex items-center gap-2 p-2 rounded border bg-muted/30">
                                <Checkbox checked={formData.isVip} onCheckedChange={(v:any) => setFormData({...formData, isVip: v})} id="vip" />
                                <label htmlFor="vip" className="text-xs font-medium cursor-pointer">สำหรับสมาชิก VIP</label>
                            </div>
                        </div>

                        <div className="border-t pt-4">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-xs font-bold">ตอนทั้งหมด ({formData.episodes.length})</span>
                                <Button type="button" onClick={handleAddEpisode} size="sm" variant="outline" className="h-6 text-[10px]">+ เพิ่มตอน</Button>
                            </div>
                            <div className="space-y-2 max-h-[150px] overflow-y-auto pr-2">
                                {formData.episodes.map((ep, i) => (
                                    <div key={i} className="flex gap-1 items-center">
                                        <Input value={ep.url} onChange={e => { const n = [...formData.episodes]; n[i].url = e.target.value; setFormData({...formData, episodes: n}); }} className="h-7 text-[10px]" placeholder={`URL ตอนที่ ${i+1}`} />
                                        <Button type="button" onClick={() => handleRemoveEpisode(i)} variant="ghost" size="icon" className="h-7 w-7 p-0 text-red-500 shrink-0">
                                          <Trash2 className="h-3 w-3" />
                                        </Button>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <Button type="submit" className="w-full bg-blue-600 hover:bg-blue-700">
                            {editingId ? "อัปเดตข้อมูล" : "บันทึกลง Cloud"}
                        </Button>
                        {editingId && <Button type="button" variant="ghost" className="w-full" onClick={resetForm}>ยกเลิกการแก้ไข</Button>}
                    </form>
                </CardContent>
            </Card>
          </div>

          {/* List Section */}
          <div className="lg:col-span-2 space-y-4">
            <div className="flex justify-between items-center">
                <h3 className="font-bold text-xl">รายการหนังในระบบ ({movies.length})</h3>
                <span className="text-[10px] text-muted-foreground italic">อัปเดตอัตโนมัติ</span>
            </div>
            <div className="grid gap-3">
                {movies.map(movie => (
                    <div key={movie.id} className="flex items-center gap-4 bg-muted/40 p-3 rounded-xl border border-border/50 hover:bg-muted/60 transition-colors">
                        <img src={movie.poster} className="h-20 w-14 rounded-lg object-cover shadow-sm bg-muted" />
                        <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2">
                                <h4 className="font-bold text-sm truncate">{movie.title}</h4>
                                {movie.isVip && <span className="bg-yellow-500 text-white text-[8px] px-1.5 py-0.5 rounded-sm font-bold">VIP</span>}
                                {movie.badge && <span className="text-[9px] bg-blue-500/10 text-blue-600 px-1.5 py-0.5 rounded border border-blue-500/20">{movie.badge}</span>}
                            </div>
                            <p className="text-[10px] text-muted-foreground line-clamp-2 mt-1">{movie.desc}</p>
                        </div>
                        <div className="flex gap-1">
                            <Button size="icon" variant="ghost" className="h-8 w-8" onClick={() => handleEdit(movie)}><Edit2 className="h-3 w-3" /></Button>
                            <Button size="icon" variant="ghost" className="h-8 w-8 text-destructive" onClick={() => handleDelete(movie.id)}><Trash2 className="h-3 w-3" /></Button>
                        </div>
                    </div>
                ))}
                {movies.length === 0 && <div className="text-center py-20 text-muted-foreground border border-dashed rounded-xl">ไม่พบข้อมูลหนังในระบบ</div>}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}